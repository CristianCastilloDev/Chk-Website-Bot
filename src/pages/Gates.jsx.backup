import { useState } from 'react';
import { motion } from 'framer-motion';
import { Shield, Send, Trash2, Download, AlertCircle, CheckCircle, XCircle, Clock, Zap } from 'lucide-react';
import DashboardLayout from '../components/DashboardLayout';
import { usePermissions } from '../hooks/usePermissions';
import { useAuth } from '../context/AuthContext';
import { updateUserCredits } from '../services/db';
import './Pages.css';

const Gates = () => {
    const [cards, setCards] = useState('');
    const [results, setResults] = useState([]);
    const [loading, setLoading] = useState(false);
    const [processing, setProcessing] = useState(false);
    const { canInteract, hasCredits, hasActiveSubscription, isAdmin, isDev } = usePermissions();
    const { user } = useAuth();

    // Cambia esta URL por la que te da ngrok
    const API_URL = import.meta.env.VITE_API_URL || 'http://192.168.56.2:8000';

    const handleValidate = async () => {
        if (!cards.trim()) {
            alert('Por favor ingresa al menos una tarjeta');
            return;
        }

        const cardList = cards.split('\n').filter(card => card.trim());

        // Verificar cr√©ditos
        if (!isAdmin() && !isDev()) {
            const creditsNeeded = cardList.length;
            if (!hasActiveSubscription() && user.credits < creditsNeeded) {
                alert(`Necesitas ${creditsNeeded} cr√©ditos. Tienes ${user.credits}. Compra m√°s cr√©ditos o un plan.`);
                return;
            }
        }

        setLoading(true);
        setProcessing(true);
        const result = parseResult(data, card, time);
        newResults.push(result);
        setResults(prev => [...prev, result]);

        // Descontar cr√©dito si no es admin/dev y no tiene plan
        if (!isAdmin() && !isDev() && !hasActiveSubscription()) {
            await updateUserCredits(user.uid, user.credits - 1);
        }

    } catch (error) {
        newResults.push({
            card,
            status: 'Error',
            result: 'Error de conexi√≥n',
            time: '0.00',
            icon: 'error'
        });
    }
}

setLoading(false);
setProcessing(false);
    };

const parseResult = (data, card, time) => {
    const text = typeof data === 'string' ? data : JSON.stringify(data);

    let status = 'Unknown';
    let result = 'Sin respuesta';
    let icon = 'error';

    if (text.includes('‚úÖ Live') || text.includes('Charged')) {
        status = 'Live';
        result = 'Charged $1 MXN';
        icon = 'live';
    } else if (text.includes('‚ö†Ô∏è Live CNN') || text.includes('security code')) {
        status = 'Live CNN';
        result = 'CVV Incorrecto';
        icon = 'warning';
    } else if (text.includes('üí∏ Fondos Insuficientes') || text.includes('insufficient funds')) {
        status = 'Fondos Insuficientes';
        result = 'Sin fondos';
        icon = 'warning';
    } else if (text.includes('‚ùå Dead') || text.includes('3D Secure')) {
        status = 'Dead';
        result = text.includes('3D Secure') ? '3D Secure' : 'Rechazada';
        icon = 'dead';
    } else if (text.includes('Fechas Invalidas')) {
        status = 'Fecha Inv√°lida';
        result = 'Fecha expirada';
        icon = 'error';
    }

    return { card, status, result, time, icon };
};

const getStatusIcon = (icon) => {
    switch (icon) {
        case 'live':
            return <CheckCircle size={18} className="status-icon-live" />;
        case 'warning':
            return <AlertCircle size={18} className="status-icon-warning" />;
        case 'dead':
            return <XCircle size={18} className="status-icon-dead" />;
        default:
            return <AlertCircle size={18} className="status-icon-error" />;
    }
};

const clearResults = () => {
    setResults([]);
    setCards('');
};

const exportResults = () => {
    const csv = 'Card,Status,Result,Time\n' +
        results.map(r => `${r.card},${r.status},${r.result},${r.time}s`).join('\n');

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `gates_results_${Date.now()}.csv`;
    a.click();
};

const canUseGates = canInteract();

return (
    <DashboardLayout currentPage="gates">
        <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.5 }}
        >
            <div className="page-header">
                <h1><Shield size={32} style={{ display: 'inline', marginRight: '10px' }} />Gates - Validador de Tarjetas</h1>
                <p>Valida tarjetas de cr√©dito en tiempo real</p>
            </div>

            {!canUseGates && (
                <div className="permission-warning">
                    <AlertCircle size={24} />
                    <div>
                        <h3>Acceso Restringido</h3>
                        <p>
                            Necesitas un plan activo o cr√©ditos para usar Gates.{' '}
                            <a href="/pricing">Ver planes</a>
                        </p>
                    </div>
                </div>
            )}

            <div className={`gates-content ${!canUseGates ? 'disabled' : ''}`}>
                {/* Stats */}
                <div className="stats-grid" style={{ marginBottom: '2rem' }}>
                    <motion.div className="stat-card glass">
                        <div className="stat-icon gradient-primary">
                            <Zap size={24} />
                        </div>
                        <div className="stat-content">
                            <h3 className="stat-value">{user?.credits || 0}</h3>
                            <p className="stat-label">Cr√©ditos Disponibles</p>
                        </div>
                    </motion.div>

                    <motion.div className="stat-card glass">
                        <div className="stat-icon gradient-accent">
                            <CheckCircle size={24} />
                        </div>
                        <div className="stat-content">
                            <h3 className="stat-value">{results.filter(r => r.icon === 'live').length}</h3>
                            <p className="stat-label">Live</p>
                        </div>
                    </motion.div>

                    <motion.div className="stat-card glass">
                        <div className="stat-icon gradient-secondary">
                            <XCircle size={24} />
                        </div>
                        <div className="stat-content">
                            <h3 className="stat-value">{results.filter(r => r.icon === 'dead').length}</h3>
                            <p className="stat-label">Dead</p>
                        </div>
                    </motion.div>
                </div>

                {/* Input Form */}
                <div className="glass" style={{ padding: '2rem', marginBottom: '2rem', borderRadius: '12px' }}>
                    <h3 style={{ marginBottom: '1rem' }}>Ingresar Tarjetas</h3>
                    <p style={{ color: 'var(--text-secondary)', marginBottom: '1rem', fontSize: '0.9rem' }}>
                        Formato: <code>4557880011223344|12|26|123</code> (una por l√≠nea)
                    </p>
                    <textarea
                        value={cards}
                        onChange={(e) => setCards(e.target.value)}
                        placeholder="4557880011223344|12|26|123&#10;5555555555554444|01|27|456"
                        rows={8}
                        style={{
                            width: '100%',
                            padding: '1rem',
                            borderRadius: '8px',
                            border: '1px solid var(--glass-border)',
                            background: 'var(--bg-secondary)',
                            color: 'var(--text-primary)',
                            fontFamily: 'monospace',
                            fontSize: '0.9rem',
                            resize: 'vertical'
                        }}
                        disabled={!canUseGates || processing}
                    />
                    <div style={{ display: 'flex', gap: '1rem', marginTop: '1rem' }}>
                        <button
                            className="btn-primary"
                            onClick={handleValidate}
                            disabled={!canUseGates || processing || !cards.trim()}
                            style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}
                        >
                            <Send size={18} />
                            {processing ? 'Procesando...' : 'Validar Tarjetas'}
                        </button>
                        <button
                            className="btn-secondary"
                            onClick={clearResults}
                            disabled={processing}
                            style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}
                        >
                            <Trash2 size={18} />
                            Limpiar
                        </button>
                        {results.length > 0 && (
                            <button
                                className="btn-secondary"
                                onClick={exportResults}
                                style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}
                            >
                                <Download size={18} />
                                Exportar CSV
                            </button>
                        )}
                    </div>
                </div>

                {/* Results Table */}
                {results.length > 0 && (
                    <div className="glass" style={{ padding: '2rem', borderRadius: '12px' }}>
                        <h3 style={{ marginBottom: '1rem' }}>Resultados ({results.length})</h3>
                        <div style={{ overflowX: 'auto' }}>
                            <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                <thead>
                                    <tr style={{ borderBottom: '2px solid var(--glass-border)' }}>
                                        <th style={{ padding: '1rem', textAlign: 'left' }}>Tarjeta</th>
                                        <th style={{ padding: '1rem', textAlign: 'left' }}>Status</th>
                                        <th style={{ padding: '1rem', textAlign: 'left' }}>Resultado</th>
                                        <th style={{ padding: '1rem', textAlign: 'left' }}>Tiempo</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {results.map((result, index) => (
                                        <motion.tr
                                            key={index}
                                            initial={{ opacity: 0, x: -20 }}
                                            animate={{ opacity: 1, x: 0 }}
                                            transition={{ delay: index * 0.05 }}
                                            style={{ borderBottom: '1px solid var(--glass-border)' }}
                                        >
                                            <td style={{ padding: '1rem', fontFamily: 'monospace', fontSize: '0.85rem' }}>
                                                {result.card}
                                            </td>
                                            <td style={{ padding: '1rem' }}>
                                                <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                                    {getStatusIcon(result.icon)}
                                                    <span style={{ fontWeight: 600 }}>{result.status}</span>
                                                </div>
                                            </td>
                                            <td style={{ padding: '1rem', color: 'var(--text-secondary)' }}>
                                                {result.result}
                                            </td>
                                            <td style={{ padding: '1rem' }}>
                                                <div style={{ display: 'flex', alignItems: 'center', gap: '0.3rem' }}>
                                                    <Clock size={14} />
                                                    {result.time}s
                                                </div>
                                            </td>
                                        </motion.tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                )}
            </div>
        </motion.div>
    </DashboardLayout>
);
};

export default Gates;
