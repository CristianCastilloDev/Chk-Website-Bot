import {
  collection,
  doc,
  getDoc,
  getDocs,
  setDoc,
  updateDoc,
  query,
  where,
  orderBy,
  serverTimestamp,
  Timestamp,
  increment
} from 'firebase/firestore';
import { db } from './firebase';

// ========== USER MANAGEMENT ==========



export const createUserDocument = async (uid, userData) => {
  try {
    const userRef = doc(db, 'users', uid);
    const newUser = {
      username: userData.username || '',
      name: userData.name || '',
      email: userData.email,
      role: userData.role || 'free',
      credits: userData.credits || 10,
      plan: userData.plan || null,
      planExpiresAt: userData.planExpiresAt || null,
      avatar: userData.avatar || null,
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    };
      ...updates,
  updatedAt: serverTimestamp()
    });
return true;
  } catch (error) {
  console.error('Error updating user document:', error);
  throw error;
}
};

export const getAllUsers = async () => {
  try {
    const usersRef = collection(db, 'users');
    const usersSnap = await getDocs(usersRef);
    const users = [];
    usersSnap.forEach((doc) => {
      users.push({ id: doc.id, ...doc.data() });
    });
    return users;
  } catch (error) {
    console.error('Error getting all users:', error);
    throw error;
  }
};

export const getUsersByRole = async (role) => {
  try {
    const usersRef = collection(db, 'users');
    const q = query(usersRef, where('role', '==', role));
    const usersSnap = await getDocs(q);
    const users = [];
    usersSnap.forEach((doc) => {
      users.push({ id: doc.id, ...doc.data() });
    });
    return users;
  } catch (error) {
    console.error('Error getting users by role:', error);
    throw error;
  }
};

// ========== CREDITS MANAGEMENT ==========

export const addCredits = async (uid, amount, description = 'Credits added') => {
  try {
    const userRef = doc(db, 'users', uid);
    await updateDoc(userRef, {
      credits: increment(amount),
      updatedAt: serverTimestamp()
    });
    await createTransaction({
      userId: uid,
      type: 'purchase',
      credits: amount,
      description
    });
    return true;
  } catch (error) {
    console.error('Error adding credits:', error);
    throw error;
  }
};

export const deductCredits = async (uid, amount, description = 'Credits used') => {
  try {
    const userRef = doc(db, 'users', uid);
    const userSnap = await getDoc(userRef);
    if (!userSnap.exists()) {
      throw new Error('User not found');
    }
    const currentCredits = userSnap.data().credits || 0;
    if (currentCredits < amount) {
      throw new Error('Insufficient credits');
    }
    await updateDoc(userRef, {
      credits: increment(-amount),
      updatedAt: serverTimestamp()
    });
    await createTransaction({
      userId: uid,
      type: 'usage',
      credits: -amount,
      description
    });
    return true;
  } catch (error) {
    console.error('Error deducting credits:', error);
    throw error;
  }
};

export const getCreditsBalance = async (uid) => {
  try {
    const user = await getUserDocument(uid);
    return user?.credits || 0;
  } catch (error) {
    console.error('Error getting credits balance:', error);
    throw error;
  }
};

// ========== PLANS MANAGEMENT ==========

export const getPlans = async () => {
  try {
    const plansRef = collection(db, 'plans');
    const q = query(plansRef, where('active', '==', true));
    const plansSnap = await getDocs(q);
    const plans = [];
    plansSnap.forEach((doc) => {
      plans.push({ id: doc.id, ...doc.data() });
    });
    return plans.sort((a, b) => a.price - b.price);
  } catch (error) {
    console.error('Error getting plans:', error);
    throw error;
  }
};

export const getPlan = async (planId) => {
  try {
    const planRef = doc(db, 'plans', planId);
    const planSnap = await getDoc(planRef);
    if (planSnap.exists()) {
      return { id: planSnap.id, ...planSnap.data() };
    }
    return null;
  } catch (error) {
    console.error('Error getting plan:', error);
    throw error;
  }
};

export const createPlan = async (planData) => {
  try {
    const planRef = doc(collection(db, 'plans'));
    const newPlan = {
      name: planData.name,
      type: planData.type,
      price: planData.price,
      credits: planData.credits,
      features: planData.features || [],
      popular: planData.popular || false,
      active: planData.active !== undefined ? planData.active : true,
      createdAt: serverTimestamp()
    };
    await setDoc(planRef, newPlan);
    return { id: planRef.id, ...newPlan };
  } catch (error) {
    console.error('Error creating plan:', error);
    throw error;
  }
};

// ========== TRANSACTIONS ==========

export const createTransaction = async (transactionData) => {
  try {
    const transactionRef = doc(collection(db, 'transactions'));
    const newTransaction = {
      userId: transactionData.userId,
      type: transactionData.type,
      credits: transactionData.credits,
      description: transactionData.description,
      createdAt: serverTimestamp()
    };
    await setDoc(transactionRef, newTransaction);
    return { id: transactionRef.id, ...newTransaction };
  } catch (error) {
    console.error('Error creating transaction:', error);
    throw error;
  }
};

export const getUserTransactions = async (uid) => {
  try {
    const transactionsRef = collection(db, 'transactions');
    const q = query(
      transactionsRef,
      where('userId', '==', uid),
      orderBy('createdAt', 'desc')
    );
    const transactionsSnap = await getDocs(q);
    const transactions = [];
    transactionsSnap.forEach((doc) => {
      transactions.push({ id: doc.id, ...doc.data() });
    });
    return transactions;
  } catch (error) {
    console.error('Error getting user transactions:', error);
    throw error;
  }
};

// ========== DASHBOARD DATA ==========

export const getDashboardData = () => {
  return {
    stats: {
      totalUsers: 1248,
      revenue: 45231,
      growth: 12.5,
      activeUsers: 892
    },
    analytics: {
      userGrowth: [
        { month: 'Jan', users: 400 },
        { month: 'Feb', users: 600 },
        { month: 'Mar', users: 800 },
        { month: 'Apr', users: 1000 },
        { month: 'May', users: 1100 },
        { month: 'Jun', users: 1248 }
      ],
      revenue: [
        { month: 'Jan', revenue: 20000 },
        { month: 'Feb', revenue: 25000 },
        { month: 'Mar', revenue: 30000 },
        { month: 'Apr', revenue: 35000 },
        { month: 'May', revenue: 40000 },
        { month: 'Jun', revenue: 45231 }
      ],
      traffic: [
        { name: 'Direct', value: 400 },
        { name: 'Social', value: 300 },
        { name: 'Organic', value: 300 },
        { name: 'Referral', value: 200 }
      ]
    }
  };
};

// ========== SALES MANAGEMENT ==========

export const createSaleRecord = async (saleData) => {
  try {
    const saleRef = doc(collection(db, 'sales'));
    const sale = {
      adminId: saleData.adminId,
      adminName: saleData.adminName,
      userId: saleData.userId,
      userName: saleData.userName,
      type: saleData.type,
      creditsAdded: saleData.creditsAdded || 0,
      planAdded: saleData.planAdded || null,
      planDuration: saleData.planDuration || null,
      previousBalance: saleData.previousBalance,
      newBalance: saleData.newBalance,
      previousPlan: saleData.previousPlan || null,
      newPlan: saleData.newPlan || null,
      amount: saleData.amount || 0,
      timestamp: serverTimestamp(),
      notes: saleData.notes || ''
    };
    await setDoc(saleRef, sale);
    return { id: saleRef.id, ...sale };
  } catch (error) {
    console.error('Error creating sale record:', error);
    throw error;
  }
};

export const addCreditsToUser = async (userId, creditsToAdd, adminId, adminName) => {
  try {
    const userRef = doc(db, 'users', userId);
    const userSnap = await getDoc(userRef);
    if (!userSnap.exists()) throw new Error('User not found');
    const userData = userSnap.data();
    const previousBalance = userData.credits || 0;
    const newBalance = previousBalance + creditsToAdd;
    await updateDoc(userRef, {
      credits: newBalance,
      updatedAt: serverTimestamp()
    });
    await createSaleRecord({
      adminId,
      adminName,
      userId,
      userName: userData.name,
      type: 'credits',
      creditsAdded: creditsToAdd,
      previousBalance,
      newBalance
    });
    return true;
  } catch (error) {
    console.error('Error adding credits:', error);
    throw error;
  }
};

export const addPlanToUser = async (userId, planDuration, adminId, adminName) => {
  try {
    const userRef = doc(db, 'users', userId);
    const userSnap = await getDoc(userRef);
    if (!userSnap.exists()) throw new Error('User not found');
    const userData = userSnap.data();
    const now = new Date();
    let newExpirationDate;
    if (userData.planExpiresAt) {
      const currentExpiration = userData.planExpiresAt.toDate();
      newExpirationDate = new Date(currentExpiration.getTime() + planDuration * 24 * 60 * 60 * 1000);
    } else {
      newExpirationDate = new Date(now.getTime() + planDuration * 24 * 60 * 60 * 1000);
    }
    const planName = planDuration === 7 ? 'Semanal' : planDuration === 30 ? 'Mensual' : `${planDuration} Días`;
    await updateDoc(userRef, {
      planExpiresAt: Timestamp.fromDate(newExpirationDate),
      planDuration: (userData.planDuration || 0) + planDuration,
      updatedAt: serverTimestamp()
    });
    await createSaleRecord({
      adminId,
      adminName,
      userId,
      userName: userData.name,
      type: 'plan',
      planAdded: planName,
      planDuration,
      previousBalance: userData.credits || 0,
      newBalance: userData.credits || 0,
      previousPlan: userData.plan || 'Free',
      newPlan: planName
    });
    return true;
  } catch (error) {
    console.error('Error adding plan:', error);
    throw error;
  }
};

export const getAllSales = async () => {
  try {
    const salesRef = collection(db, 'sales');
    const q = query(salesRef, orderBy('timestamp', 'desc'));
    const salesSnap = await getDocs(q);
    const sales = [];
    salesSnap.forEach((doc) => {
      sales.push({ id: doc.id, ...doc.data() });
    });
    return sales;
  } catch (error) {
    console.error('Error getting sales:', error);
    return [];
  }
};

export const getUserSales = async (userId) => {
  try {
    const salesRef = collection(db, 'sales');
    const q = query(salesRef, where('userId', '==', userId), orderBy('timestamp', 'desc'));
    const salesSnap = await getDocs(q);
    const sales = [];
    salesSnap.forEach((doc) => {
      sales.push({ id: doc.id, ...doc.data() });
    });
    return sales;
  } catch (error) {
    console.error('Error getting user sales:', error);
    return [];
  }
};

export const getUserLifetimeStats = async (userId) => {
  try {
    const sales = await getUserSales(userId);
    let totalCreditsAdded = 0;
    let totalMoneySpent = 0;
    sales.forEach(sale => {
      if (sale.type === 'credits') {
        totalCreditsAdded += sale.creditsAdded || 0;
      }
      totalMoneySpent += sale.amount || 0;
    });
    return {
      totalCreditsAdded,
      totalMoneySpent,
      totalTransactions: sales.length,
      lastPurchase: sales[0] || null
    };
  } catch (error) {
    console.error('Error getting user lifetime stats:', error);
    return {
      totalCreditsAdded: 0,
      totalMoneySpent: 0,
      totalTransactions: 0,
      lastPurchase: null
    };
  }
};

// ========== PERMISSION VERIFICATION ==========

export const verifyDevPermissions = async (userId) => {
  try {
    const userRef = doc(db, 'users', userId);
    const userSnap = await getDoc(userRef);
    if (!userSnap.exists()) {
      throw new Error('Usuario no encontrado');
    }
    const userData = userSnap.data();
    if (userData.role !== 'dev') {
      throw new Error('Solo los usuarios Dev pueden realizar esta acción');
    }
    return userData;
  } catch (error) {
    console.error('Error verifying dev permissions:', error);
    throw error;
  }
};

export const updateUserRole = async (userId, newRole, adminId) => {
  try {
    await verifyDevPermissions(adminId);
    const userRef = doc(db, 'users', userId);
    await updateDoc(userRef, {
      role: newRole,
      updatedAt: serverTimestamp()
    });
    return true;
  } catch (error) {
    console.error('Error updating user role:', error);
    throw error;
  }
};


// ========== USERNAME FUNCTIONS ==========

export const validateUsername = (username) => {
  if (!username || typeof username !== 'string') return false;
  if (username.length < 3 || username.length > 20) return false;
  const usernameRegex = /^[a-zA-Z0-9_]+$/;
  return usernameRegex.test(username);
};

export const getUserByUsername = async (username) => {
  try {
    const usersRef = collection(db, 'users');
    const q = query(usersRef, where('username', '==', username));
    const usersSnap = await getDocs(q);
    if (usersSnap.empty) return null;
    const userDoc = usersSnap.docs[0];
    return { id: userDoc.id, ...userDoc.data() };
  } catch (error) {
    console.error('Error getting user by username:', error);
    throw error;
  }
};

export const checkUsernameAvailable = async (username) => {
  try {
    const user = await getUserByUsername(username);
    return user === null;
  } catch (error) {
    console.error('Error checking username availability:', error);
    throw error;
  }
};

